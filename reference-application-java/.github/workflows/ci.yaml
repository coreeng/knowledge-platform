name: CI
on:
  pull_request:
    branches:
      - main
  push:
    branches: main
jobs:
  Local:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Build
        run: |
          make build
      - name: Setup minikube
        id: minikube
        uses: medyagh/setup-minikube@master
        with:
          driver: docker
          cni: bridge
          addons: registry,ingress # addons for minikube
          insecure-registry: 'localhost:5000,10.0.0.0/24'
      - name: Setup Docker
        uses: docker/setup-buildx-action@v1
      - name: Configure Docker-Minikube registry
        run: |
          docker run -d --rm --network=host alpine ash -c "apk add socat && socat TCP-LISTEN:5000,reuseaddr,fork TCP:$(minikube ip):5000"
      - name: Docker build and push
        run: |
          make docker-build-push-all
      - name: Install Helm
        uses: azure/setup-helm@v3
      - name: Deploy Reference App
        run: |
          make helm-deploy
      - name: Test Reference App
        run: |
          make helm-test
